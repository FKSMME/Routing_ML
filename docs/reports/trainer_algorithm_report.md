> PRD Ref: PRD.md (v2025-09-28.1) | Tasklist Ref: Tasklist.md (v2025-09-28.1) | Sprint Pending 36 | Completed 5 | Blockers 0

# 절대 지령
1. 각 단계는 승인 후에만 진행한다.
2. 단계 착수 전 이번 단계 전체 범위를 리뷰하고 오류를 식별한다.
3. 오류 발견 시 수정 전에 승인 재요청한다.
4. 이전 단계 오류가 없음을 재확인한 뒤 다음 단계 승인을 요청한다.
5. 모든 단계 작업은 백그라운드 방식으로 수행한다.
6. 문서/웹뷰어 점검이 필요한 경우 반드시 승인 확인 후 진행한다.
7. 다음 단계 착수 전에 이전 단계 전반을 재점검하여 미해결 오류가 없는지 확인한다.

# Trainer 모듈 알고리즘 설명 (주니어용)
## 1. 학습 데이터 준비 흐름
- `trainer_ml.py`는 학습 데이터가 이미 판다스 DataFrame 형태로 준비돼 있다고 가정하고 `ITEM_CD`와 기타 특성 열만 사용한다. (`train_model_with_ml_improved` 함수 내부 `df_subset = df[["ITEM_CD"] + feature_cols]`).
- Access 원본(`dbo_BI_ITEM_INFO_VIEW`, `dbo_BI_ROUTING_VIEW`, `dbo_BI_WORK_ORDER_RESULTS`)에서 각각 어떤 열을 끌어오는지는 코드 밖(데이터 파이프라인 단계)에서 처리해야 하며, 트레이너는 전달받은 DataFrame을 그대로 활용한다.

## 2. 전처리 단계
1. **열 분리**: 숫자형(feature list `NUMERIC_FEATURES`)과 범주형을 나눔.
2. **깨끗한 값 만들기**: 숫자는 결측/문자 등을 0으로 바꾸고, 문자열은 공백·NULL을 `missing`으로 통일.
3. **인코딩**: 범주형은 `OrdinalEncoder`로 숫자로 바꿈. (`ImprovedPreprocessor.fit`)
4. **가중치 적용**: Seal 제조 도메인 기본 가중치 + 분산 기반 자동 가중치를 섞어서 열마다 중요도를 곱함.
5. **분산 필터**: 거의 변하지 않는 열(variance threshold 이하) 삭제.
6. **표준화**: 평균 0, 표준편차 1이 되도록 스케일 조정.
7. **(선택) PCA/차원밸런스**: 필요한 경우 주성분분석으로 차원 축소 후, 각 차원의 표준편차를 비슷하게 맞춤.

## 3. 품목별 임베딩 만들기
1. 같은 품목(`ITEM_CD`)을 묶어서 그룹 평균 벡터를 만든다. (`ImprovedPreprocessor.process_all`)
2. 임베딩 벡터의 길이를 일정하게 유지하기 위해 부드러운 L2 정규화(soft normalization)를 적용한다.
3. 값이 거의 0인 차원(표준편차가 아주 작은 축)은 제거해서 노이즈를 줄인다.

## 4. 검색 인덱스 학습
1. 전처리된 벡터들을 메모리에 모아 `HNSWSearch` 인덱스를 만든다. (벡터 차원 128로 맞춘 뒤)
2. 이 인덱스는 나중에 입력 벡터와 코사인 유사도에 가까운 점수를 빠르게 구하는 역할.
3. 학습이 끝나면 인덱스, 인코더, 스케일러, 피처 목록을 joblib으로 저장한다.

## 5. TensorBoard Projector 연동
- 현재 코드에는 Projector 내보내기 옵션 파라미터가 선언되어 있으나 실제 내보내기 로직은 비어 있어 후속 구현이 필요하다.

# 기획 의도 대비 구현 현황 분석
| 기획 절대 조건 | 현재 구현 상태 | 비고 |
| --- | --- | --- |
| 1. `dbo_BI_ITEM_INFO_VIEW` 컬럼 기준 임베딩 | **부분 충족** – 트레이너는 해당 뷰의 열 목록을 전제로 설계되어 있으나 실제 DB에서 읽어오는 로직은 별도 단계 필요 | DataFrame 입력이 외부에서 채워져야 함 |
| 2. ITEM_CD 기준 3개 뷰 조인 학습 | **미충족** – `trainer_ml.py`는 조인이나 실적 테이블 연계 로직을 포함하지 않음 | 데이터 파이프라인 모듈에서 구현 필요 |
| 3. 유사 품목 탐색 + 연관관계 학습 | **부분 충족** – 임베딩과 HNSW로 유사 품목 검색은 가능, 그러나 라우팅/작업실적과의 학습 규칙은 미구현 | 추가 피처 공학/멀티뷰 학습 필요 |
| 4. 유사도 80% 이상 보장 알고리즘 | **미충족** – 현재 HNSW 검색은 유사도 점수만 반환하며, 0.8 이상을 강제하는 보정 로직이 없음 | 후보 필터링/재학습 로직 추가 필요 |

# 후속 조치 제안
1. 데이터 파이프라인에서 Access 세 뷰를 ITEM_CD 기준으로 미리 조인하고, 기획서의 피처 구성을 만족하도록 `TRAIN_FEATURES`를 검증.
2. `trainer_ml.py`에 라우팅/실적 지표(예: SETUP/MACH_WORKED_HOURS 통계)를 추가 피처로 반영하는 확장 설계.
3. 학습 후 유사도 점수를 0.8 이상으로 끌어올리기 위한 재학습 또는 후보 필터링(예: threshold 이하일 때 추가 이웃 탐색) 로직 검토.
4. TensorBoard Projector 내보내기 구현을 보완하여 벡터 시각화 산출물 확보.

