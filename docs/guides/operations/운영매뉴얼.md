# Routing ML v4 운영 매뉴얼

**버전**: 1.0.0
**작성일**: 2025-10-06
**대상**: 운영팀, DevOps, SRE

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [일상 운영](#일상-운영)
3. [모니터링](#모니터링)
4. [백업 및 복구](#백업-및-복구)
5. [트러블슈팅](#트러블슈팅)
6. [정기 작업](#정기-작업)
7. [비상 연락망](#비상-연락망)

---

## 🎯 시스템 개요

### 아키텍처
```
사용자 (Browser)
  ↓
Frontend (React + Vite)
  ↓
API Server (FastAPI)
  ↓
ML Model (scikit-learn + HNSW)
  ↓
Database (Access DB)
```

### 주요 컴포넌트
| 컴포넌트 | 설명 | 포트 | 상태 확인 |
|----------|------|------|-----------|
| Frontend (Prediction) | 예측 UI | 5173 | http://localhost:5173 |
| Frontend (Training) | 학습 UI | 5174 | http://localhost:5174 |
| Backend API | FastAPI 서버 | 8000 | http://localhost:8000/api/health |
| Access DB | 라우팅 데이터 | - | 파일 존재 확인 |

### 배포 위치
- **개발**: `/workspaces/Routing_ML_4`
- **운영**: TBD

---

## 🔄 일상 운영

### 시스템 시작

#### 1. Backend 시작
```bash
cd /workspaces/Routing_ML_4
source venv-linux/bin/activate
python -m uvicorn backend.run_api:app --host 0.0.0.0 --port 8000
```

#### 2. Frontend 시작 (Prediction)
```bash
cd /workspaces/Routing_ML_4/frontend-prediction
npm run dev
```

#### 3. Frontend 시작 (Training)
```bash
cd /workspaces/Routing_ML_4/frontend-training
npm run dev
```

### 시스템 종료

#### 정상 종료
```bash
# Frontend (Ctrl+C로 종료)

# Backend
pkill -f "uvicorn backend.run_api:app"

# 또는 프로세스 ID 확인 후 종료
ps aux | grep uvicorn
kill <PID>
```

#### 강제 종료 (비상시)
```bash
pkill -9 -f uvicorn
pkill -9 -f vite
```

### 상태 확인

#### Health Check
```bash
# API 상태
curl http://localhost:8000/api/health | jq

# 응답 예시:
# {
#   "status": "healthy",
#   "version": "0.1.0",
#   "uptime_seconds": 3600.5
# }
```

#### 프로세스 확인
```bash
# 실행 중인 프로세스
ps aux | grep -E "uvicorn|vite"

# 포트 사용 확인
ss -tuln | grep -E ":(5173|5174|8000)"
```

#### 로그 확인
```bash
# Backend 로그
tail -f logs/api.log

# 특정 에러 검색
grep ERROR logs/api.log | tail -20
```

---

## 📊 모니터링

### Health Check (필수)

#### 매일 09:00 - 시스템 상태 확인
```bash
curl http://localhost:8000/api/health
```

**정상**: `status: "healthy"`
**비정상**: `status: "degraded"` 또는 `"unhealthy"`

### Metrics 확인

#### Prometheus Metrics
```bash
curl http://localhost:8000/api/metrics

# 주요 메트릭:
# routing_ml_uptime_seconds - 가동 시간
# routing_ml_requests_total - 총 요청 수
# routing_ml_errors_total - 총 에러 수
# routing_ml_predictions_total - 총 예측 수
```

#### Drift Status
```bash
curl http://localhost:8000/api/drift/status | jq

# drift_detected: true인 경우 재학습 필요
```

### Grafana 대시보드 (향후)

**URL**: http://grafana.company.com/routing-ml

**주요 패널**:
1. Request Rate (QPS)
2. Error Rate (%)
3. Prediction Latency (p50, p95, p99)
4. Drift Events (7일)
5. Model Accuracy Trend

### 알림 설정

#### Slack 알림
- **Critical**: 서비스 다운, DB 연결 실패
- **Warning**: Drift 탐지, 높은 에러율 (>5%)
- **Info**: 재학습 완료, 보안 스캔 결과

---

## 💾 백업 및 복구

### 자동 백업

#### 1. Access DB 백업 (매일 00:00)
```bash
# Cron job 확인
crontab -l | grep backup_access_db

# 백업 파일 위치
ls -lh /mnt/backup/routing_db_*.accdb

# 최신 백업 확인
ls -lt /mnt/backup/ | head -5
```

#### 2. 모델 백업
```bash
# 모델 디렉토리
ls -lh /workspaces/Routing_ML_4/deliverables/models/

# 활성 모델 확인
readlink -f deliverables/models/active
```

### 수동 백업

#### Access DB
```bash
cp "/mnt/data/routing_data/ROUTING AUTO TEST.accdb" \
   "/mnt/backup/manual_backup_$(date +%Y%m%d_%H%M%S).accdb"
```

#### 전체 시스템
```bash
# 코드 + 설정
tar -czf routing_ml_backup_$(date +%Y%m%d).tar.gz \
  --exclude=node_modules \
  --exclude=.venv \
  --exclude=venv-linux \
  /workspaces/Routing_ML_4

# 모델만
tar -czf models_backup_$(date +%Y%m%d).tar.gz \
  /workspaces/Routing_ML_4/deliverables/models/
```

### 복구 절차

#### 1. DB 복구
```bash
# 백업 파일 확인
ls -lh /mnt/backup/routing_db_*.accdb

# 복구 (운영 DB 교체)
cp /mnt/backup/routing_db_20251005.accdb \
   "/mnt/data/routing_data/ROUTING AUTO TEST.accdb"

# 권한 확인
chmod 644 "/mnt/data/routing_data/ROUTING AUTO TEST.accdb"
```

#### 2. 모델 롤백
```bash
cd /workspaces/Routing_ML_4/deliverables/models/

# 이전 모델로 롤백
ln -sfn model_20251001_020002 active

# 확인
ls -la active
```

#### 3. 전체 시스템 복구
```bash
# 백업 압축 해제
tar -xzf routing_ml_backup_20251005.tar.gz -C /tmp/

# 필요한 파일 복사
cp -r /tmp/workspaces/Routing_ML_4/backend /workspaces/Routing_ML_4/
cp -r /tmp/workspaces/Routing_ML_4/frontend-* /workspaces/Routing_ML_4/

# 의존성 재설치
cd /workspaces/Routing_ML_4
source venv-linux/bin/activate
pip install -r requirements.txt

cd frontend-prediction && npm install
cd ../frontend-training && npm install
```

---

## 🔧 트러블슈팅

### 문제 1: API 서버 응답 없음

**증상**:
```bash
curl http://localhost:8000/api/health
# curl: (7) Failed to connect to localhost port 8000
```

**원인**: 서버 다운 또는 포트 충돌

**해결**:
```bash
# 1. 프로세스 확인
ps aux | grep uvicorn

# 2. 포트 확인
ss -tuln | grep 8000

# 3. 서버 재시작
cd /workspaces/Routing_ML_4
source venv-linux/bin/activate
python -m uvicorn backend.run_api:app --host 0.0.0.0 --port 8000

# 4. 로그 확인
tail -f logs/api.log
```

### 문제 2: DB 연결 실패

**증상**:
```
ERROR: Could not connect to Access database
```

**원인**: DB 파일 없음, 권한 문제, 네트워크 장애

**해결**:
```bash
# 1. 파일 존재 확인
ls -lh "/mnt/data/routing_data/ROUTING AUTO TEST.accdb"

# 2. 권한 확인
stat "/mnt/data/routing_data/ROUTING AUTO TEST.accdb"

# 3. 네트워크 마운트 확인 (네트워크 드라이브인 경우)
df -h | grep /mnt/data

# 4. 백업에서 복구
cp /mnt/backup/routing_db_latest.accdb \
   "/mnt/data/routing_data/ROUTING AUTO TEST.accdb"
```

### 문제 3: 높은 에러율 (>10%)

**증상**:
```bash
curl http://localhost:8000/api/metrics | grep errors_total
# routing_ml_errors_total 1500
```

**원인**: 모델 drift, 데이터 품질 저하

**해결**:
```bash
# 1. Drift 상태 확인
curl http://localhost:8000/api/drift/status | jq

# 2. 재학습 필요 시
bash scripts/monthly_retrain.sh

# 3. 데이터 품질 확인
# (로컬 작업 필요)
```

### 문제 4: 느린 응답 속도 (>1s)

**증상**: 예측 요청 응답 시간 > 1초

**원인**: HNSW 인덱스 크기, 메모리 부족

**해결**:
```bash
# 1. 메모리 사용량 확인
free -h
ps aux --sort=-%mem | head -10

# 2. HNSW 인덱스 재구축
# (backend/predictor_ml.py에서 ef_search 파라미터 조정)

# 3. 서버 재시작
pkill -f uvicorn
python -m uvicorn backend.run_api:app --host 0.0.0.0 --port 8000
```

### 문제 5: TypeScript 빌드 에러

**증상**:
```
npm run build
# ERROR: TS2304: Cannot find name '...'
```

**해결**:
```bash
# 1. 타입 재생성
bash scripts/generate_api_types.sh

# 2. node_modules 재설치
cd frontend-prediction
rm -rf node_modules package-lock.json
npm install

# 3. 타입 체크
npx tsc --noEmit
```

---

## 📅 정기 작업

### 매일

#### 09:00 - 시스템 상태 확인
```bash
# Health check
curl http://localhost:8000/api/health | jq

# Drift status
curl http://localhost:8000/api/drift/status | jq
```

#### 18:00 - 로그 리뷰
```bash
# 에러 로그 확인
grep ERROR logs/api.log | tail -50

# 경고 로그 확인
grep WARNING logs/api.log | tail -50
```

### 매주

#### 월요일 09:00 - 보안 스캔 (자동)
```bash
# GitHub Actions에서 자동 실행
# 결과 확인: https://github.com/your-repo/security

# 수동 실행:
bash scripts/security_scan.sh
```

#### 금요일 17:00 - 주간 리뷰
1. 완료된 작업 체크
2. Drift 이벤트 리뷰
3. 에러율 추이 확인
4. 다음 주 계획

### 매월

#### 1일 02:00 - 모델 재학습 (자동)
```bash
# Cron job에서 자동 실행
# 로그 확인:
cat logs/retraining/retrain_$(date +%Y%m)*.log

# 수동 실행:
bash scripts/monthly_retrain.sh
```

#### 마지막 금요일 - 월간 리뷰
1. ROI 실적 확인
2. 모델 정확도 추이
3. 사용자 피드백 수집
4. 다음 달 목표 설정

### 분기별

#### Q1, Q2, Q3, Q4 마지막 주
1. ADR (Architecture Decision Records) 리뷰
2. 시스템 성능 벤치마크
3. 보안 감사
4. 문서 업데이트

---

## 📞 비상 연락망

### Tier 1: 운영팀
| 역할 | 이름 | 전화 | 이메일 | 대응 시간 |
|------|------|------|--------|-----------|
| 운영 리더 | 홍길동 | 010-1234-5678 | ops-lead@company.com | 24/7 |
| DevOps 엔지니어 | 김철수 | 010-2345-6789 | devops@company.com | 09:00-18:00 |

### Tier 2: 개발팀
| 역할 | 이름 | 전화 | 이메일 | 대응 시간 |
|------|------|------|--------|-----------|
| ML 엔지니어 | 박영희 | 010-3456-7890 | ml-engineer@company.com | 09:00-18:00 |
| 백엔드 개발자 | 이민수 | 010-4567-8901 | backend-dev@company.com | 09:00-18:00 |

### Tier 3: 관리자
| 역할 | 이름 | 전화 | 이메일 | 대응 시간 |
|------|------|------|--------|-----------|
| CTO | 최영수 | 010-5678-9012 | cto@company.com | 긴급 시 |
| PM | 정수진 | 010-6789-0123 | pm@company.com | 긴급 시 |

### 에스컬레이션 규칙
1. **Severity 1 (Critical)**: 즉시 Tier 1 → 30분 내 해결 안 되면 Tier 2
2. **Severity 2 (High)**: 1시간 내 Tier 1 → 4시간 내 해결 안 되면 Tier 2
3. **Severity 3 (Medium)**: 업무 시간 내 Tier 1
4. **Severity 4 (Low)**: 다음 정기 작업 시 처리

---

## 📚 참고 문서

### 기술 문서
- [API 문서](../api/README.md)
- [재해 복구 절차](../disaster_recovery.md)
- [보안 스캔 가이드](../security_scanning.md)
- [Concept Drift 탐지](../concept_drift_detection.md)

### 개발 문서
- [월간 재학습 설정](../monthly_retraining_setup.md)
- [OpenAPI 타입 생성](../openapi_type_generation.md)
- [테마 토글 가이드](../theme_toggle_guide.md)

### 관리 문서
- [ROI 계산서](../ROI_계산서.md)
- [프로젝트 리스크 분석](../../프로젝트_리스크분석_및_비전.md)
- [개선 목표 체크리스트](../../개선목표_체크리스트.md)

---

## 📋 체크리스트

### 일일 점검
- [ ] API Health Check 확인
- [ ] Drift Status 확인
- [ ] 에러 로그 리뷰
- [ ] 디스크 용량 확인 (`df -h`)

### 주간 점검
- [ ] 보안 스캔 결과 확인
- [ ] 백업 파일 확인
- [ ] 성능 메트릭 리뷰
- [ ] 사용자 피드백 수집

### 월간 점검
- [ ] 모델 재학습 로그 확인
- [ ] ROI 실적 리뷰
- [ ] 문서 업데이트
- [ ] 다음 달 계획 수립

---

**작성**: ML Team
**최종 업데이트**: 2025-10-06
**다음 리뷰**: 2025-11-06
**버전**: 1.0.0
