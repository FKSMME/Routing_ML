> PRD Ref: PRD.md (v2025-09-28.1) | Tasklist Ref: Tasklist.md (v2025-09-28.1) | Sprint Pending 36 | Completed 5 | Blockers 0

# 절대 지령
1. 각 단계는 승인 후에만 진행한다.
2. 단계 착수 전 이번 단계 전체 범위를 리뷰하고 오류를 식별한다.
3. 오류 발견 시 수정 전에 승인 재요청한다.
4. 이전 단계 오류가 없음을 재확인한 뒤 다음 단계 승인을 요청한다.
5. 모든 단계 작업은 백그라운드 방식으로 수행한다.
6. 문서/웹뷰어 점검이 필요한 경우 반드시 승인 확인 후 진행한다.
7. 다음 단계 착수 전에 이전 단계 전반을 재점검하여 미해결 오류가 없는지 확인한다.

## Stage 6 Execution Report: 평가/모니터링

### Gate Review Summary
- 승인 타임스탬프: 2025-09-25T08:25:00Z (Stage 5 산출물 재검토 후 오류 없음 확인)
- 범위 검토: KPI 정의, 평가 파이프라인, 대시보드/리포트, 모니터링 알람
- 승인 전 확인 사항: Stage 5 SQL 산출물 스키마와 predictor 저장 로직 재점검, 분석 도구 접근 승인

### KPI 정의
- **단계 일치율(Stage Match Rate)**: `정확히 일치한 공정 단계 수 / 전체 공정 단계 수`. 목표 ≥ 0.82. 라우팅 단계 시퀀스 매칭 기반.
- **시간 일치율(Time Deviation Accuracy)**: `1 - |예상시간 - 실제시간| / 실제시간`. 허용 오차 ±15%.
- **후보 채택률**: 사용자가 추천 라우팅을 그대로 채택한 비율. Stage 4 UI 로그와 연계.
- **알림 대응 시간**: 이상 탐지 알림을 수신 후 조치까지 걸린 평균 시간.
- 베이스라인: 현재 룰 기반 라우팅의 단계 일치율 0.68, 시간 오차 ±28분.

### 평가 파이프라인 설계
- 입력: Stage 5 저장 테이블(`routing_candidates`, `routing_candidate_operations`)과 실적 테이블(`work_order_results`).
- 흐름: 데이터 추출 → 키 정합성 검증 → 시퀀스 매칭(Levenshtein 기반) → KPI 계산 → 결과 저장(`evaluation_runs`, `evaluation_metrics`).
- 메타데이터: 평가 실행 ID(UUID), 모델 버전, 데이터 스냅샷 타임스탬프.
- 스케줄: 일일 02:00 UTC 백그라운드 잡, 필요 시 수동 재실행.

### 구현 계획
- **시퀀스 매칭 의사코드**: `align_sequences(pred_steps, actual_steps)` 함수에서 동적 계획법 사용, 삽입/삭제 비용 1, 교체 비용 2.
- **시간 지표 계산**: `mae_duration`, `mape_duration` 함수로 구현, 시간 단위는 분.
- **대시보드 파이프라인**: 평가 결과를 `metrics_timeseries` 뷰에 적재, Grafana 대시보드와 연동.
- **리포트 자동화**: Python `report_builder.py`에서 KPI 요약, 상위/하위 라우팅 사례, 경고 목록을 PDF/HTML로 생성.

### 테스트 전략
- **샘플 데이터 검증**: Stage 5 샘플 후보와 실적 10건으로 드라이런 수행, 기대 지표와 수동 계산 비교.
- **단위 테스트**: 시퀀스 매칭, MAE/MAPE 함수, 알림 임계값 처리에 대한 pytest 케이스 준비.
- **대시보드 데이터 검증**: 필드 매핑 리스트와 최신성(5분 내 동기화) 점검 체크리스트.
- **리포트 Dry-run**: QA 환경에서 주간 리포트 생성 → 승인자 리뷰 후 운영 배포 승인 요청.

### 배포 준비
- 스케줄링: Airflow DAG `routing_evaluation_dag` 작성, 백그라운드 실행(큐 워커).
- 모니터링: CloudWatch 지표 + Slack 알림, 임계값 초과 시 PagerDuty 트리거.
- 접근 권한: 대시보드 뷰어 역할 분리(운영/분석/경영). 승인 로그 보관.
- 게이트 종료: Stage 6 완료 보고 후 Stage 7 승인 요청, 선행 단계 오류 미존재 증빙 포함.

### 위험 및 후속 조치
- 실적 데이터 지연 시 KPI 오차 발생 가능 → 데이터 추출 지연 감지 알람 구성.
- 평가 파이프라인 리소스 사용량 급증 대비 스케일링 정책 마련(Auto Scaling Group 조정).
- 알림 피로도 방지를 위해 Stage 7에서 알람 임계값 튜닝 계획 수립.
