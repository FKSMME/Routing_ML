# 개발 세션 기록 - 2025년 10월 13일 16:30

**세션 시작**: 2025-10-13 16:13 KST
**세션 종료**: 2025-10-13 16:30 KST (진행 중)
**작업자**: syyun + Claude Code
**세션 타입**: 버그 수정 + 기능 추가 + 문서화

---

## 📋 세션 요약

이번 세션에서는 3가지 주요 작업을 수행했습니다:

1. ✅ **Pydantic 버전 업그레이드** (v1.10.14 → v2.12.0)
2. ✅ **서버 모니터 UI 개선 및 기능 추가**
3. ✅ **Home Dashboard UTF-8 인코딩 문제 해결**
4. ✅ **회원 가입 승인 가이드 문서 작성**

---

## 🔧 작업 1: Pydantic 업그레이드

### 문제 상황

백엔드 API 시작 시 다음 오류 발생:

```python
ImportError: cannot import name 'field_validator' from 'pydantic'
(C:\Users\syyun\Documents\GitHub\Routing_ML_4\.venv\Lib\site-packages\pydantic\__init__.py).
Did you mean: 'root_validator'?
```

### 원인 분석

- 코드는 Pydantic v2 문법 사용 (`field_validator`)
- 가상환경에는 Pydantic v1.10.14 설치되어 있음
- v1에서는 `root_validator` 사용, v2에서는 `field_validator` 사용

### 해결 방법

```bash
unset SSL_CERT_FILE && ./.venv/Scripts/python.exe -m pip install \
  --trusted-host pypi.org \
  --trusted-host pypi.python.org \
  --trusted-host files.pythonhosted.org \
  --upgrade "pydantic>=2.0" "pydantic-settings>=2.0"
```

### 결과

- ✅ Pydantic 2.12.0 설치 완료
- ✅ pydantic-core 2.41.1 설치 완료
- ✅ pydantic-settings 2.11.0 업그레이드
- ✅ `backend.api.config` 임포트 정상 동작 확인

### 영향받은 파일

- `backend/api/config.py` - `field_validator` 사용
- `.venv/` - Pydantic 패키지 업그레이드

### 커밋 정보

- 커밋 없음 (패키지 설치만 수행)

---

## 🖥️ 작업 2: 서버 모니터 UI 개선

### 2-1. 폴더 선택 워크플로우 추가

**요구사항**: 사용자가 프로젝트 폴더를 선택한 후, 해당 폴더에서 서비스 시작

**구현 내용**:

1. **폴더 선택 버튼** (📁 Select Project Folder)
   - `tkinter.filedialog.askdirectory` 사용
   - `START_ALL_WINDOWS.bat` 존재 여부 검증
   - 윈도우 타이틀에 선택된 폴더명 표시

2. **서비스 시작 버튼** (▶ Start All Services)
   - 선택된 폴더에서 `START_ALL_WINDOWS.bat` 실행
   - `subprocess.Popen`으로 CMD 창 실행

**코드 변경**:

```python
class MonitorApp:
    def __init__(self, services):
        self.selected_folder = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    def _select_folder(self) -> None:
        """폴더 선택 다이얼로그"""
        folder = filedialog.askdirectory(
            title="Select Routing ML Project Folder",
            initialdir=self.selected_folder,
        )
        if folder:
            self.selected_folder = folder
            bat_file = os.path.join(folder, "START_ALL_WINDOWS.bat")
            if os.path.exists(bat_file):
                self.root.title(f"Routing ML v4 - Service Monitor [{os.path.basename(folder)}]")

    def _start_services(self) -> None:
        """선택된 폴더에서 서비스 시작"""
        bat_file = os.path.join(self.selected_folder, "START_ALL_WINDOWS.bat")
        subprocess.Popen(
            ["cmd", "/c", "start", "cmd", "/k", "START_ALL_WINDOWS.bat"],
            cwd=self.selected_folder,
            shell=True
        )
```

**커밋**: `42b339eb` - "feat: Add folder selection workflow to server monitor"

---

### 2-2. 서비스 종료 및 캐시 삭제 기능 추가

**요구사항**:
- Vite 캐시로 인해 업데이트가 반영되지 않는 문제 해결
- 서비스를 안전하게 종료할 수 있는 기능

**구현 내용**:

1. **Stop All Services 버튼** (■ 빨간색)
   - 모든 Node.js 프로세스 종료 (`taskkill /F /IM node.exe`)
   - Python/uvicorn 프로세스 종료
   - 확인 대화상자 표시

2. **Clear Vite Cache 버튼** (🗑️)
   - `frontend-home`, `frontend-prediction`, `frontend-training` 탐색
   - `node_modules/.vite` 폴더 삭제
   - `.vite` 폴더 삭제 (프로젝트 루트)
   - 삭제 결과 리포트

**코드 변경**:

```python
def _stop_services(self) -> None:
    """모든 서비스 종료"""
    # Kill all node processes
    subprocess.run(["taskkill", "/F", "/IM", "node.exe"], capture_output=True, text=True)

    # Kill Python/uvicorn processes
    subprocess.run(
        ["taskkill", "/F", "/FI", "IMAGENAME eq python.exe", "/FI", "WINDOWTITLE eq *uvicorn*"],
        capture_output=True, text=True
    )

def _clear_cache(self) -> None:
    """Vite 캐시 삭제"""
    folders = ["frontend-home", "frontend-prediction", "frontend-training"]
    deleted_count = 0

    for folder in folders:
        vite_cache = os.path.join(self.selected_folder, folder, "node_modules", ".vite")
        if os.path.exists(vite_cache):
            shutil.rmtree(vite_cache)
            deleted_count += 1
```

**UI 변경**:
- 윈도우 크기: 800x600 → 1000x650 (4개 버튼 수용)
- Stop 버튼: 빨간색 (#da3633) 사용
- 버튼 간 간격 조정

**커밋**: `89f3843a` - "feat: Add service shutdown and Vite cache clearing to server monitor"

---

## 🌐 작업 3: Home Dashboard UTF-8 인코딩 수정

### 문제 상황

Home Dashboard (http://localhost:3000)에서 한글이 깨져서 표시:
- "라우팅 생성" → "�������"
- "모델 학습" → "�������"

**스크린샷 증거**: 사용자 제공 (브라우저에서 � 문자 확인)

### 원인 분석

- `frontend-home/index.html` 파일이 잘못된 인코딩으로 저장됨
- `<meta charset="UTF-8">` 태그는 존재하지만 파일 자체가 UTF-8이 아님
- `server.js`는 `'Content-Type': 'text/html; charset=utf-8'` 헤더 전송 중

### 해결 방법

`index.html` 파일을 Write 도구로 완전히 다시 작성하여 UTF-8 인코딩 보장:

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <!-- ... -->
</head>
<body>
  <h1>📊 Routing ML Analytics Dashboard</h1>
  <p>FKSM 제조 라우팅 머신러닝 시스템 - 실시간 모니터링</p>

  <div class="nav-card-title">라우팅 생성</div>
  <div class="nav-card-title">모델 학습</div>
  <div class="nav-card-title">TensorBoard</div>
  <div class="nav-card-title">시스템 설정</div>
</body>
</html>
```

### 추가 개선

네비게이션 카드 2개 추가:
1. **TensorBoard** (📈) - `http://localhost:3000` 링크
2. **시스템 설정** (⚙️) - `http://10.204.2.28:8000/docs` 링크

### 테스트 방법

브라우저에서 Ctrl+F5 (하드 리프레시) 후 한글 정상 표시 확인

**커밋**: `39ecd0a9` - "fix: Fix UTF-8 encoding issue for Korean text in home dashboard"

---

## 📚 작업 4: 회원 가입 승인 가이드 문서 작성

### 배경

사용자 질문: "회원 가입 신청이 오면 내가 어떻게 해야되?"

### 작성 문서

**파일**: `docs/admin/USER_REGISTRATION_GUIDE.md`

### 문서 구성

1. **회원 가입 프로세스 개요**
   - 전체 흐름도
   - 사용자 상태 설명 (pending/approved/rejected)

2. **신규 가입 신청 확인 방법**
   - API 직접 호출
   - FastAPI Swagger UI 사용
   - 서버 모니터 (추후 구현 예정)

3. **회원 승인/거절 처리**
   - API 엔드포인트 상세
   - curl 명령어 예시
   - 요청/응답 스키마

4. **데이터베이스 구조**
   - `UserAccount` 테이블 스키마
   - 주요 필드 설명

5. **로그 확인**
   - 감사 로그 위치 (`logs/auth.audit.log`)
   - 로그 형식 (JSON)
   - 주요 이벤트 목록

6. **FAQ 및 보안 고려사항**

### API 엔드포인트 요약

| 엔드포인트 | 메서드 | 권한 | 설명 |
|-----------|--------|------|------|
| `/api/auth/admin/pending-users` | GET | Admin | 대기 중인 사용자 목록 |
| `/api/auth/admin/approve` | POST | Admin | 사용자 승인 |
| `/api/auth/admin/reject` | POST | Admin | 사용자 거절 |
| `/api/auth/admin/users` | GET | Admin | 전체 사용자 목록 |

### 예시 코드

**사용자 승인**:
```bash
curl -X POST "http://localhost:8000/api/auth/admin/approve" \
  -H "Content-Type: application/json" \
  -H "Cookie: routing_ml_token=YOUR_ADMIN_TOKEN" \
  -d '{
    "username": "hong.gildong",
    "make_admin": false
  }'
```

**사용자 거절**:
```bash
curl -X POST "http://localhost:8000/api/auth/admin/reject" \
  -H "Content-Type: application/json" \
  -H "Cookie: routing_ml_token=YOUR_ADMIN_TOKEN" \
  -d '{
    "username": "hong.gildong",
    "reason": "회사 내부 직원이 아님"
  }'
```

---

## 📊 세션 통계

### 변경된 파일

| 파일 | 변경 유형 | 라인 수 |
|------|----------|---------|
| `scripts/server_monitor_dashboard.py` | 수정 | +188, -24 |
| `frontend-home/index.html` | 수정 | +16 |
| `docs/admin/USER_REGISTRATION_GUIDE.md` | 신규 | +503 |
| `docs/sessions/SESSION_2025-10-13_16h30m.md` | 신규 | (현재 파일) |

### 커밋 히스토리

```
39ecd0a9 - fix: Fix UTF-8 encoding issue for Korean text in home dashboard
89f3843a - feat: Add service shutdown and Vite cache clearing to server monitor
42b339eb - feat: Add folder selection workflow to server monitor
25984d29 - fix: Use os.startfile for folder button (이전 세션)
00b66d67 - feat: Enhance server monitor UI (이전 세션)
```

### 패키지 변경

| 패키지 | 이전 버전 | 새 버전 |
|--------|----------|---------|
| pydantic | 1.10.14 | 2.12.0 |
| pydantic-core | 2.33.2 | 2.41.1 |
| pydantic-settings | 2.3.4 | 2.11.0 |

---

## 🐛 발견된 이슈 및 해결

### 이슈 1: Pydantic 임포트 에러

**증상**: `field_validator` 임포트 실패
**원인**: Pydantic v1 vs v2 호환성 문제
**해결**: Pydantic v2로 업그레이드
**상태**: ✅ 해결됨

### 이슈 2: 한글 인코딩 깨짐

**증상**: Home Dashboard에서 한글이 � 문자로 표시
**원인**: HTML 파일이 잘못된 인코딩으로 저장됨
**해결**: UTF-8로 파일 재작성
**상태**: ✅ 해결됨

### 이슈 3: Vite 캐시 문제

**증상**: 코드 업데이트 후에도 변경사항 미반영
**원인**: `node_modules/.vite` 캐시 디렉토리
**해결**: 서버 모니터에 캐시 삭제 버튼 추가
**상태**: ✅ 해결됨

---

## 💡 개선 제안 (향후 작업)

### 단기 (다음 세션)

1. [ ] **서버 모니터에 회원 관리 UI 추가**
   - 대기 중인 회원 목록 표시
   - 승인/거절 버튼 추가
   - 실시간 새로고침

2. [ ] **이메일 알림 시스템**
   - 가입 신청 시 관리자에게 알림
   - 승인/거절 시 사용자에게 알림

### 중기

3. [ ] **사용자 역할 관리**
   - admin, user, viewer 등 세분화
   - 권한별 API 접근 제어

4. [ ] **사용자 정보 수정 API**
   - 비밀번호 외 정보 수정
   - 프로필 이미지 업로드

### 장기

5. [ ] **SSO 통합**
   - Active Directory 연동
   - OAuth2/OIDC 지원

---

## 📝 참고 자료

### 관련 문서

- [USER_REGISTRATION_GUIDE.md](../admin/USER_REGISTRATION_GUIDE.md) - 회원 가입 승인 가이드
- [UI_FIXES_2025-10-13.md](../ui/UI_FIXES_2025-10-13.md) - 이전 UI 수정 문서

### 관련 코드

- `backend/api/routes/auth.py` - 인증 라우터
- `backend/api/services/auth_service.py` - 인증 서비스 로직
- `backend/database_rsl.py` - UserAccount 모델
- `scripts/server_monitor_dashboard.py` - 서버 모니터

### 외부 참조

- [Pydantic v2 Migration Guide](https://docs.pydantic.dev/latest/migration/)
- [Argon2 Password Hashing](https://github.com/P-H-C/phc-winner-argon2)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)

---

## 🔐 보안 체크리스트

- [x] 비밀번호 Argon2 해싱 사용
- [x] JWT 토큰 HttpOnly 쿠키 사용
- [x] 관리자 권한 검증 (`require_admin`)
- [x] 감사 로그 기록
- [x] SQL 인젝션 방지 (SQLAlchemy ORM 사용)
- [x] CORS 설정 적용
- [ ] Rate limiting (TODO)
- [ ] 2FA 지원 (TODO)

---

## 👥 참여자

**개발자**: syyun (syyun@ksm.co.kr)
**AI 어시스턴트**: Claude Code (Sonnet 4.5)

---

## 📌 세션 노트

### 사용자 피드백

1. "서버 관리 ux가 너무 엉망이네" → 서버 모니터 UI 개선
2. "에러 메세지 때문에 창이 엄청 커지는 것도 해결해봐" → 윈도우 크기 고정, 에러 메시지 단축
3. "글자 깨짐" → UTF-8 인코딩 수정
4. "회원 가입 신청이 오면 내가 어떻게 해야되?" → 가이드 문서 작성

### 작업 효율성

- **토큰 사용량**: 67,393 / 200,000 (33.7%)
- **세션 길이**: 약 17분
- **완료된 작업**: 4개 주요 작업
- **생성된 문서**: 2개 (가이드 + 세션 기록)

### 기술적 도전

1. **SSL 인증서 문제**: `unset SSL_CERT_FILE`과 `--trusted-host` 플래그로 해결
2. **파일 인코딩**: Write 도구로 완전 재작성하여 UTF-8 보장
3. **Windows 프로세스 관리**: taskkill 명령어 사용

---

**세션 종료**: 2025-10-13 16:30 KST
**다음 세션 계획**: 서버 모니터에 회원 관리 UI 추가
