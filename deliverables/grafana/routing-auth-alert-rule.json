{
  "apiVersion": 1,
  "groups": [
    {
      "name": "routing-auth-alerts",
      "folder": "Routing-ML",
      "interval": "1m",
      "orgId": 1,
      "rules": [
        {
          "uid": "routing-auth-401-spike",
          "title": "Routing Auth 401 Spike",
          "condition": "C",
          "data": [
            {
              "refId": "A",
              "relativeTimeRange": { "from": 300, "to": 0 },
              "datasourceUid": "grafana-prometheus-datasource",
              "model": {
                "expr": "sum(increase(routing_ml_auth_401_total[5m]))",
                "format": "time_series",
                "intervalFactor": 1,
                "legendFormat": "401 total",
                "refId": "A"
              }
            },
            {
              "refId": "B",
              "relativeTimeRange": { "from": 300, "to": 0 },
              "datasourceUid": "-100",
              "model": {
                "conditions": [
                  {
                    "evaluator": { "params": [15], "type": "gt" },
                    "operator": { "type": "and" },
                    "query": { "params": ["A"] },
                    "reducer": { "type": "last" },
                    "type": "query"
                  }
                ],
                "datasource": { "type": "datasource", "uid": "-100" },
                "expression": "A",
                "reducer": { "params": [], "type": "last" },
                "refId": "B",
                "type": "reduce"
              }
            },
            {
              "refId": "C",
              "relativeTimeRange": { "from": 300, "to": 0 },
              "datasourceUid": "-100",
              "model": {
                "datasource": { "type": "datasource", "uid": "-100" },
                "expression": "B",
                "refId": "C",
                "type": "threshold",
                "conditions": []
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "Error",
          "for": "2m",
          "labels": {
            "team": "routing-ml"
          },
          "annotations": {
            "summary": "401 responses exceeded threshold (15 in 5 minutes)."
          }
        },
        {
          "uid": "routing-auth-latency",
          "title": "Routing Auth Handshake Latency",
          "condition": "C",
          "data": [
            {
              "refId": "A",
              "relativeTimeRange": { "from": 300, "to": 0 },
              "datasourceUid": "grafana-prometheus-datasource",
              "model": {
                "expr": "histogram_quantile(0.95, sum by (le)(rate(routing_ml_auth_handshake_seconds_bucket[5m])))",
                "format": "time_series",
                "legendFormat": "p95 latency",
                "refId": "A"
              }
            },
            {
              "refId": "B",
              "relativeTimeRange": { "from": 300, "to": 0 },
              "datasourceUid": "-100",
              "model": {
                "conditions": [
                  {
                    "evaluator": { "params": [1.5], "type": "gt" },
                    "operator": { "type": "and" },
                    "query": { "params": ["A"] },
                    "reducer": { "type": "last" },
                    "type": "query"
                  }
                ],
                "datasource": { "type": "datasource", "uid": "-100" },
                "expression": "A",
                "refId": "B",
                "type": "reduce"
              }
            },
            {
              "refId": "C",
              "relativeTimeRange": { "from": 300, "to": 0 },
              "datasourceUid": "-100",
              "model": {
                "datasource": { "type": "datasource", "uid": "-100" },
                "expression": "B",
                "refId": "C",
                "type": "threshold",
                "conditions": []
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "Error",
          "for": "3m",
          "labels": {
            "team": "routing-ml"
          },
          "annotations": {
            "summary": "Auth handshake p95 latency has remained above 1.5s."
          }
        }
      ]
    }
  ]
}
